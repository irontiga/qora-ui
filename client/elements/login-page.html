<link rel="import" href="/client/bower_components/polymer/polymer.html">

<link rel="import" href="/client/bower_components/paper-input/paper-input.html">
<link rel="import" href="/client/bower_components/paper-card/paper-card.html">
<link rel="import" href="/client/bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="/client/bower_components/paper-button/paper-button.html">
<link rel="import" href="/client/bower_components/paper-progress/paper-progress.html">
<link rel="import" href="/client/bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="/client/bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="/client/bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="/client/bower_components/paper-item/paper-item.html">
<link rel="import" href="/client/bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="/client/bower_components/neon-animation/web-animations.html">
<link rel="import" href="/client/bower_components/paper-progress/paper-progress.html">
<link rel="import" href="/client/bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="/client/bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="/client/bower_components/iron-pages/iron-pages.html">
<link rel="import" href="/client/bower_components/neon-animation/neon-animated-pages.html">

<link rel="import" href="/client/styles/app-theme.html">


<dom-module id="login-page">
    
    <template>
        <style is="custom-style"  include="burst-styles iron-flex iron-flex-alignment iron-positioning iron-flex-factors">
            #login-container{
                position:absolute;
                width:100%;
                height:100%;
                background: url("/client/img/purple_white_bg.jpg") no-repeat center center fixed;
                background-size: cover;
                z-index:3;
            }
            :host > *{
                --paper-button-ink-color: var(--dark-accent-color)
            }
            paper-progress{
                z-index:4;
                width:100%;
                --paper-progress-active-color: var(--accent-color);
                --paper-progress-container-color: var(--primary-color);
            }
            paper-spinner{
                z-index:4;
            }
            .show-advanced{
                text-align:right;
                padding:14px 0 0 0;
            }
            .show-advanced a{
                cursor: pointer;
                color: var(--accent-color);
            }
            .error-message{
                width:100%;
                text-align: right;
                color: var(--paper-red-500)
            }
            paper-button[disabled]{
                background: transparent;
            }
            paper-card {
                --paper-card-header-color: #333;
                
                --paper-card-header	: {
                    text-align: center;
                    padding-top:10px;
                    padding-bottom:10px;
                    border-bottom: 2px solid #ccc;
                    font-family: "Roboto Mono", monospace;
                }
            }
        </style>
        <template is="dom-if" if="{{!loginpage.loggedin}}">
            <div id="login-container" class="layout vertical center-justified">
                <!--<div class="layout horizontal center-justified">
                    <paper-spinner active></paper-spinner>
                </div>-->
                <div class="layout horizontal center-justified">
                    <paper-card heading="Login" style="min-width:350px;">
                        <template is="dom-if" if="{{loginpage.loading}}">
                            <paper-progress indeterminate></paper-progress>
                        </template>
                        
                        <paper-tabs id="loginTabs" selected="{{loginType}}">
                            <paper-tab>Passphrase</paper-tab>
                            <paper-tab>Seed</paper-tab>
                            <!--<paper-tab>Address</paper-tab>-->
                        </paper-tabs>
                        
                        
                        <div class="card-content">
                            
                            <neon-animated-pages style="height:120px" selected="{{loginType}}" entry-animation="fade-in-animation" exit-animation="fade-out-animation">
                                
                                <neon-animatable>
                                    <!--Passphrase -->
                                    
                                    <paper-input char-counter label="Passphrase" type="password" id="passphrase" value="{{passphrase}}" autofocus on-keydown="_loginKeyDown">
                                        <iron-icon icon="icons:lock" slot="prefix" style="color:#333; padding-right: 6px;"></iron-icon>
                                    </paper-input>
                                    <paper-input pattern="[0-9]*" auto-validate="true" maxlength="4" minlength="4" label="Pin" type="password" id="pin" value="{{pin}}" autofocus on-keydown="_loginKeyDown">
                                        <iron-icon icon="av:fiber-pin" slot="prefix" style="color:#333; padding-right: 6px;"></iron-icon>
                                    </paper-input>
                                    
                                </neon-animatable>
                                <neon-animatable>
                                    <!-- Generation seed -->
                                    <paper-input char-counter label="Qora generation seed" type="password" id="generationSeed" value="{{generationSeed}}" on-keydown="_loginKeyDown">
                                        <iron-icon icon="communication:vpn-key" slot="prefix" style="color:#333; padding-right: 6px;"></iron-icon>
                                    </paper-input>
                                    <paper-input pattern="[0-9]*" auto-validate="true" maxlength="4" minlength="4" label="Pin" type="password" id="pin2" value="{{pin}}" autofocus on-keydown="_loginKeyDown">
                                        <iron-icon icon="av:fiber-pin" slot="prefix" style="color:#333; padding-right: 6px;"></iron-icon>
                                    </paper-input>
                                </neon-animatable>
                                <!--<neon-animatable>
                                    <paper-input disabled label="Coming soon..." type="text" id="qoraAddress" value="{{qoraAddress}}" on-keydown="_loginKeyDown"></paper-input>
                                </neon-animatable>-->
                            </neon-animated-pages>
                            
                            
                            
                            
                            <span class="error-message">{{loginpage.errorMessage}}</span>
                            
                            
                            <template is="dom-if" if="{{!loginpage.loading}}">
                                <div class="show-advanced">
                                    <a on-tap="_showAdvanced"><small>Advanced</small></a>
                                </div>


                                <iron-collapse id="advanced">
                                    <div>
                                        <h4>Node options</h4>
                                        
                                        <paper-input label="Explorer URL" type="text" value="{{node.explorer.url}}" on-keydown="_loginKeyDown"></paper-input>
                                        <paper-input label="API URL" type="text" value="{{node.api.url}}" on-keydown="_loginKeyDown"></paper-input>
                                    </div>
                                    <div>
                                        <h4>Wallet options</h4>
                                        <!-- GET RID OF IT -->
                                        <paper-input label="Number of addresses" type="number" value="{{addressCount.cnt}}" on-keydown="_loginKeyDown"></paper-input>
                                    </div>
                                </iron-collapse>
                            </template>
                            
                            
<!--
<paper-input label="Protocl" type="text" value="{{node.protocol}}"></paper-input>
<paper-input label="Node URL" type="text" value="{{node.url}}"></paper-input>
<paper-input label="Port" type="number" value="{{node.port}}"></paper-input>
-->
                        </div>
                        <div class="card-actions">
                            <paper-button on-tap="_newAccountClick">New Account</paper-button>
                            <paper-button style="float:right" on-tap="_loginClick">Login</paper-button>
                        </div>
                    </paper-card>
                </div>
            </div>
            
            <!-- NEW ACCOUNT DIALOG -->
            <paper-dialog with-backdrop id="newAccountDialog" entry-animation="fade-in-animation" exit-animation="fade-out-animation">
                <h2>Creating a new Qora account</h2>
                <h3>Passphrase</h3>
                <p>
                    With this wallet there is no need to "create" an account. Simply enter a passphrase (a long password) and a pin of your choice. This combination will point to a Qora address, and whenever you login with the same passphrase and pin, you will see the same account. It is recommended that you choose a very strong passphrase which meets the following criteria, as it is all that stands between you and a hacker. You can NOT use your qora generation seed as your passphrase(at least not if you want to see the same addresses as in your qora wallet), as it is processed differently.
                    
                    <ul>
                        <li>Is at least 15 characters long</li>
                        <li>Contains a capital letter</li>
                        <li>Contains a lowercase letter</li>
                        <li>Contains a number</li>
                        <li>Contains a symbol</li>
                    </ul>
                
                </p>
                
                <h3>Pin</h3>
                <p>
                    You can choose any 4 digit pin.
                </p>
            </paper-dialog>
            <!-- -->
        </template>
    </template>
    
    <script src="/client/js/resources/helpers.js"></script>
    <script>
        parentWindow = new ParentHelper();
        
        class LoginPage extends Polymer.Element{
            static get is(){
                return "login-page";
            }
            
            static get properties(){
                return {
                    loginpage: {
                        type: Object
                    },
                    node:{
                        type: Object,
                        notify: true
                    },
                    addressCount: {
                        type: Number,
                        notify: true
                    },
                    override: {
                        type: String,
                        value: ""
                    },
                    loginType: {
                        /*
                    0 = Passphrase
                    1 = Generation seed
                    2 = Address viewing mode
                    */
                        type: Number,
                        value: 0
                    }
                }
            }
            
            constructor() {
                super()
            }
            
            
            _loggedin(loading){
                console.log(loading);
                console.log(this.shadowRoot.querySelector("#loginTabs"));
                //this.shadowRoot.querySelector("#loginTabs").select(0);
                console.log(this.loginType);
                this.loginType = 0;
            }
            _showAdvanced(){
                this.shadowRoot.querySelector("#advanced").toggle();
                /*
                var moreInfo = document.getElementById('more-info');
                var iconButton = Polymer.dom(event).localTarget;
                iconButton.icon = moreInfo.opened ? 'hardware:keyboard-arrow-down' : 'hardware:keyboard-arrow-up';
                moreInfo.toggle();
                */
            }
        
            _loginKeyDown(e){
                if (e.keyCode === 13) {
                    this._loginClick();
                }
            }
            _loginClick(){
                //console.log(passphrase);
                //console.log(this.node);
                
                // Pin
                if(this.pin == undefined){return;}
                if(this.pin.length != 4){return;}
                
                // Passphrase
                if(this.loginType === 0){
                    if(this.passphrase == undefined){return;}
                    if(this.passphrase.length == 0){return;}
                    if(this.passphrase.length < 15){
                        //...no no no, bad idea bro
                        if (this.override != this.passphrase){
                            this.set("loginpage.errorMessage", "Passphrase too short. Should be at least 15 characters. Press enter/login again to override this.");
                            this.override = this.passphrase;
                            return;
                        }
                    }
                    this.loginpage.login(this.passphrase, this.pin, this.loginType, this.shadowRoot.querySelector('#passphrase'));
                }
                
                // Generation seed...
                if(this.loginType === 1){
                    // Add error handling
                    this.loginpage.login(this.generationSeed, this.pin, this.loginType, this.shadowRoot.querySelector('#generationSeed'));
                }
                
                
                // Which way are we logging in?
                //this.loginpage.login(this.passphrase, this.pin, this.shadowRoot.querySelector('#passphrase'));
                //this.passphrase = this.$$("#passphrase").value
            }
            _newAccountClick(e){
                this.shadowRoot.querySelector("#newAccountDialog").open();
            }
            ready(){
                super.ready();
                
                setTimeout(function(){
                    //this.loginType = 0;
                    const tabs = this.shadowRoot.querySelector("#loginTabs");
                    tabs.select(0);
                    tabs.notifyResize();
                }.bind(this), 1)
                
                
            }
            
        }
        
        customElements.define(LoginPage.is, LoginPage);
    </script>
</dom-module>
