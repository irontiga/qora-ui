!function(r){var n={};function e(s){if(n[s])return n[s].exports;var a=n[s]={i:s,l:!1,exports:{}};return r[s].call(a.exports,a,a.exports,e),a.l=!0,a.exports}e.m=r,e.c=n,e.d=function(r,n,s){e.o(r,n)||Object.defineProperty(r,n,{configurable:!1,enumerable:!0,get:s})},e.r=function(r){Object.defineProperty(r,"__esModule",{value:!0})},e.n=function(r){var n=r&&r.__esModule?function(){return r.default}:function(){return r};return e.d(n,"a",n),n},e.o=function(r,n){return Object.prototype.hasOwnProperty.call(r,n)},e.p="",e(e.s="./plugins/core/main-src.js")}({"./plugins/core/main-src.js":
/*!**********************************!*\
  !*** ./plugins/core/main-src.js ***!
  \**********************************/
/*! no exports provided */function(module,__webpack_exports__,__webpack_require__){"use strict";eval('__webpack_require__.r(__webpack_exports__);\n/* harmony import */ var _streams_StreamManager_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./streams/StreamManager.js */ "./plugins/core/streams/StreamManager.js");\n// Gets compiled into main.js\r\n\r\n\r\n\r\nWimp.init();\r\n\r\nconst parentWimp = new Wimp(window.parent);\r\n\r\nparentWimp.request("registerUrl", {\r\n    data: {\r\n        url: "wallet",\r\n        page: "core/wallet/index.html",\r\n        title: "Wallet",\r\n        icon: "credit-card",\r\n        menus: [],\r\n        parent: false\r\n    }\r\n}, response => {\r\n    //console.log(response);\r\n});\r\n\r\nparentWimp.request("registerUrl", {\r\n    data: {\r\n        url: "send-money",\r\n        page: "core/send-money-page/index.html",\r\n        title: "Send money",\r\n        icon: "send",\r\n        menus: [],\r\n        parent: false\r\n    }\r\n}, response => {\r\n    //console.log(response);\r\n});\r\n\r\n// Changing to a whole page for sending...better for mobile, and otherwise i\'d need to fix wimp proxies....which sounds like a nightmare\r\n// parentWimp.request("registerTopMenuModal", {\r\n//     data: {\r\n//         icon: "send",\r\n//         page: "core/wallet/send-money.html",\r\n//         text: "Send KMX"\r\n//     }\r\n// }, response => {\r\n//     //console.log(response);\r\n// });\r\n\r\nconst streams = new _streams_StreamManager_js__WEBPACK_IMPORTED_MODULE_0__["default"](parentWimp)\r\n\r\n/* ====================================\r\nCore streams\r\n==================================== */\r\n\r\n\r\n\r\n\r\n\r\n\r\n// const streamScript = document.createElement("script");\r\n// streamScript.type = "text/javascript";\r\n// // streamScript.type = "module" // In the future :)\r\n// streamScript.async = false;\r\n// streamScript.src = "/plugins/core/addressStream.js";\r\n// document.body.appendChild(streamScript);\r\n\n\n//# sourceURL=webpack:///./plugins/core/main-src.js?')},"./plugins/core/streams/AddressWatcher.js":
/*!************************************************!*\
  !*** ./plugins/core/streams/AddressWatcher.js ***!
  \************************************************/
/*! exports provided: default */function(module,__webpack_exports__,__webpack_require__){"use strict";eval('__webpack_require__.r(__webpack_exports__);\nconst transactionTests = []\r\nconst blockTests = []\r\n\r\nconst DEFAULT_ADDRESS_INFO = {}\r\n\r\n\r\ntransactionTests.push((tx, addr) => {\r\n    return tx.recipient === addr || tx.sender === addr\r\n})\r\n\r\n\r\nblockTests.push((block, addr) => {\r\n    return block.generator === addr\r\n})\r\n\r\nclass AddressWatcher {\r\n    constructor (parentWimp, addresses) {\r\n        addresses = addresses || []\r\n        this._parentWimp = parentWimp\r\n        this.reset()\r\n\r\n        addresses.forEach(addr => this.addAddress(addr))\r\n    }\r\n\r\n    reset () {\r\n        this._addresses = {}\r\n        this._addressStreams = {}\r\n    }\r\n\r\n    // Adds an address to watch\r\n    addAddress (address) {\r\n        const addr = address.address\r\n        this._addresses[addr] = address\r\n\r\n        this._addressStreams[addr] = this._parentWimp.createStream(`address/${addr}`, (req, res) => {\r\n            res(this._addresses[addr])\r\n        })\r\n\r\n        this.updateAddress(addr)\r\n    }\r\n\r\n    // Moved to inside of block test\r\n    // testTransaction (transaction) {\r\n        \r\n    // }\r\n\r\n    testBlock (block) {\r\n        const pendingUpdateAddresses = []\r\n\r\n        // blockTests.forEach(fn => {\r\n\r\n        // })\r\n// transactionTests.forEach(fn => {\r\n\r\n        block.transactions.forEach(transaction => {\r\n            console.log(this)\r\n            // fn(transaction, Object.keys(this._addresses))\r\n            for (const addr of Object.keys(this._addresses)) {\r\n                const addrChanged = transactionTests.some(fn => {\r\n                    return fn(transaction, addr)\r\n                })\r\n                if (!addrChanged) return\r\n\r\n                if (!(addr in pendingUpdateAddresses)) pendingUpdateAddresses.push(addr)\r\n                /**\r\n                 * In the future transactions are potentially stored from here...and address is updated excluding transactions...and also somehow manage tx pages...\r\n                 * Probably will just make wallet etc. listen for address change and then do the api call itself. If tx. page is on, say, page 3...and there\'s a new transaction...\r\n                 * it will refresh, changing the "page" to have 1 extra transaction at the top and losing 1 at the bottom (pushed to next page)\r\n                 */\r\n            }\r\n        })\r\n\r\n        pendingUpdateAddresses.forEach(addr => this.updateAddress(addr))\r\n    }\r\n\r\n    async updateAddress(addr) {\r\n        console.log("UPPPDDAAATTTINGGG AADDDRRR", addr)\r\n        const addressRequest = await this._parentWimp.request("qoraApiCall", {\r\n            data: {\r\n                type: "explorer",\r\n                data: {\r\n                    addr: addr,\r\n                    txOnPage: 10\r\n                }\r\n            }\r\n        })\r\n        console.log("response: ",addressRequest)\r\n\r\n        const addressInfo = addressRequest.success ? addressRequest.data : DEFAULT_ADDRESS_INFO\r\n        addressInfo.transactions = []\r\n\r\n        for (let i = addressInfo.start; i >= addressInfo.end; i--) {\r\n            addressInfo.transactions.push(addressInfo[i])\r\n            delete addressInfo[i]\r\n        }\r\n\r\n        if(!this._addresses[addr]) return\r\n\r\n        this._addresses[addr] = addressInfo\r\n        this._addressStreams[addr].emit(addressInfo)\r\n    }\r\n}\r\n\r\n/* harmony default export */ __webpack_exports__["default"] = (AddressWatcher);\r\n\n\n//# sourceURL=webpack:///./plugins/core/streams/AddressWatcher.js?')},"./plugins/core/streams/BlockChecker.js":
/*!**********************************************!*\
  !*** ./plugins/core/streams/BlockChecker.js ***!
  \**********************************************/
/*! exports provided: default */function(module,__webpack_exports__,__webpack_require__){"use strict";eval('__webpack_require__.r(__webpack_exports__);\n// // DW about logging in before checking blocks\r\n// blockCheck()\r\n\r\nconst BLOCK_CHECK_INTERVAL = 3000\r\nconst BLOCK_CHECK_TIMEOUT = 3000 \r\n\r\nclass BlockChecker {\r\n    constructor (parentWimp) {\r\n        this._parentWimp = parentWimp\r\n        this._eachNewBlockFunctions = []\r\n        this._lastBlock = {\r\n            height: -1\r\n        }\r\n        \r\n        this._blockStream = parentWimp.createStream("New block", (req, res) => {\r\n            res(this._lastBlock)\r\n        })\r\n    }\r\n\r\n    check () {\r\n        const c = this._check()\r\n        // console.log(c)\r\n        // CHANGE TO Promise.prototype.finally\r\n        c.then(() => {\r\n            setTimeout(() => this.check(), BLOCK_CHECK_INTERVAL)\r\n        })\r\n        c.catch(() => {\r\n            setTimeout(() => this.check(), BLOCK_CHECK_INTERVAL)\r\n        })\r\n    }\r\n\r\n    async _check () {\r\n        let timeout = setTimeout(() => {\r\n            throw new Error("Block check timed out")\r\n        }, BLOCK_CHECK_TIMEOUT)\r\n\r\n        const latestBlock = await this._parentWimp.request("qoraApiCall", {\r\n            data: {\r\n                type: "api",\r\n                url: "blocks/last"\r\n            }\r\n        })\r\n        clearTimeout(timeout)\r\n\r\n        const parsedBlock = JSON.parse(latestBlock.data)\r\n        if (parsedBlock.height > this._lastBlock.height) {\r\n            this._lastBlock = parsedBlock\r\n            this._blockStream.emit(this._lastBlock)\r\n            this._eachNewBlockFunctions.forEach(fn => fn(this._lastBlock))\r\n        }\r\n        return\r\n    }\r\n\r\n    addNewBlockFunction (fn) {\r\n        this._eachNewBlockFunctions.push(fn)\r\n    }\r\n\r\n}\r\n\r\n/* harmony default export */ __webpack_exports__["default"] = (BlockChecker);\n\n//# sourceURL=webpack:///./plugins/core/streams/BlockChecker.js?')},"./plugins/core/streams/StreamManager.js":
/*!***********************************************!*\
  !*** ./plugins/core/streams/StreamManager.js ***!
  \***********************************************/
/*! exports provided: default */function(module,__webpack_exports__,__webpack_require__){"use strict";eval('__webpack_require__.r(__webpack_exports__);\n/* harmony import */ var _BlockChecker_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./BlockChecker.js */ "./plugins/core/streams/BlockChecker.js");\n/* harmony import */ var _AddressWatcher_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./AddressWatcher.js */ "./plugins/core/streams/AddressWatcher.js");\n/* harmony import */ var _UnconfirmedTransactionWatcher_js__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! ./UnconfirmedTransactionWatcher.js */ "./plugins/core/streams/UnconfirmedTransactionWatcher.js");\n\r\n\r\n\r\n\r\nclass StreamManager {\r\n    constructor (parentWimp) {\r\n        this._parentWimp = parentWimp\r\n\r\n        this._blockCheck = new _BlockChecker_js__WEBPACK_IMPORTED_MODULE_0__["default"](parentWimp)\r\n        this._addressWatcher = new _AddressWatcher_js__WEBPACK_IMPORTED_MODULE_1__["default"](parentWimp)\r\n        this._unconfirmedTransactionWatcher = new _UnconfirmedTransactionWatcher_js__WEBPACK_IMPORTED_MODULE_2__["default"](parentWimp)\r\n\r\n        parentWimp.on(\'login\', async () => {\r\n            const addressesResponse = await parentWimp.request("getQoraAddresses")\r\n            this.updateAddresses(addressesResponse.data)\r\n        })\r\n        \r\n        this._blockCheck.addNewBlockFunction(this._addressWatcher.testBlock.bind(this._addressWatcher))\r\n\r\n        this._blockCheck.check()\r\n        this._unconfirmedTransactionWatcher.check()\r\n    }\r\n\r\n    updateAddresses(addresses) {\r\n        this._addressWatcher.reset()\r\n        addresses.forEach(addr => this._addressWatcher.addAddress(addr))\r\n        this._unconfirmedTransactionWatcher.reset()\r\n        addresses.forEach(addr => this._unconfirmedTransactionWatcher.addAddress(addr))\r\n    }\r\n}\r\n\r\n/* harmony default export */ __webpack_exports__["default"] = (StreamManager);\n\n//# sourceURL=webpack:///./plugins/core/streams/StreamManager.js?')},"./plugins/core/streams/UnconfirmedTransactionWatcher.js":
/*!***************************************************************!*\
  !*** ./plugins/core/streams/UnconfirmedTransactionWatcher.js ***!
  \***************************************************************/
/*! exports provided: default */function(module,__webpack_exports__,__webpack_require__){"use strict";eval('__webpack_require__.r(__webpack_exports__);\nclass UnconfirmedTransactionWatcher {\r\n    constructor (parentWimp) {\r\n        this._parentWimp = parentWimp\r\n        this._unconfirmedTransactionStreams = {}\r\n        this.reset() // Sets defaults\r\n    }\r\n\r\n    reset() {\r\n        this._addresses = {}\r\n        this._addressesUnconfirmedTransactions = {}\r\n    }\r\n\r\n    // Adds an address to watch\r\n    addAddress(address) {\r\n        console.log("Added address", address)\r\n        const addr = address.address\r\n        this._addresses[addr] = address\r\n        this._addressesUnconfirmedTransactions[addr] = []\r\n\r\n        if(this._unconfirmedTransactionStreams[addr]) return \r\n        console.log("CREATING A STRTRREEAAAMMMM")\r\n        this._unconfirmedTransactionStreams[addr] = this._parentWimp.createStream(`unconfirmedOfAddress/${addr}`, (req, res) => {\r\n            // res(this._addresses[address.address])\r\n            res(this._addressesUnconfirmedTransactions[addr])\r\n        })\r\n\r\n        // this.updateAddress(address.address)\r\n    }\r\n\r\n    check() {\r\n        const c = this._addressTransactionCheck()\r\n            .then(() => setTimeout(() => this.check(), 10000))\r\n            .catch(() => setTimeout(() => this.check(), 10000))\r\n            console.log(c)\r\n    }\r\n\r\n    async _addressTransactionCheck(){\r\n        console.log("Checking for unconfirmed transactions")\r\n        console.log(this._addresses, Object.keys(this._addresses))\r\n        return Promise.all(Object.keys(this._addresses).map(addr => {\r\n            console.log(`checking ${addr}`)\r\n            return this._parentWimp.request("qoraApiCall", {\r\n                data: {\r\n                    type: "api",\r\n                    url: `transactions/unconfirmedof/${addr}`\r\n                }\r\n            }).then(unconfirmedTransactions => {\r\n                unconfirmedTransactions = JSON.parse(unconfirmedTransactions.data)\r\n                console.log(unconfirmedTransactions, unconfirmedTransactions.length)\r\n                if(unconfirmedTransactions.length === 0) {\r\n                    return\r\n                }\r\n                this._unconfirmedTransactionStreams[addr].emit(unconfirmedTransactions)\r\n                console.log(this._unconfirmedTransactionStreams[addr])\r\n                return\r\n            })\r\n        }))\r\n    }\r\n}\r\n\r\n/* harmony default export */ __webpack_exports__["default"] = (UnconfirmedTransactionWatcher);\n\n//# sourceURL=webpack:///./plugins/core/streams/UnconfirmedTransactionWatcher.js?')}});