<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/client/bower_components/webcomponentsjs/webcomponents-loader.js"></script>

    <link rel="import" href="/client/bower_components/polymer/polymer.html">

    <link rel="stylesheet" href="/client/fonts/roboto.css">
    <link rel="stylesheet" href="/client/fonts/roboto-mono.css">
    
    <link rel="import" href="/client/bower_components/web-animations-js/web-animations-next.min.js">
    <link rel="import" href="/client/bower_components/neon-animation/web-animations.html">
    
    <link rel="import" href="/client/bower_components/iron-icons/iron-icons.html">
    <link rel="import" href="/client/bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
    <link rel="import" href="/client/bower_components/paper-item/paper-item.html">
    <link rel="import" href="/client/bower_components/paper-listbox/paper-listbox.html">
    <link rel="import" href="/client/bower_components/paper-progress/paper-progress.html">
    <link rel="import" href="/client/bower_components/paper-button/paper-button.html">

    <link rel="import" href="/client/styles/app-theme.html">
    
    

    <style>
        html, body {
            padding: 0;
            margin: 0;
            font-family: "Roboto", sans-serif;
        }
/*
        body{
            padding: 0 12px;
        }
*/
    </style>
</head>
    
<body>
    <dom-module id="wallet-app">
        <template>
            <custom-style>
                <style is="custom-style" include="burst-styles">
                    #sendMoneyWrapper{
                        width:435px; /* Extra 3px for left border */
                    }
                    #sendMoneyWrapper > * {
                        width: 400px !important;
                        padding: 0 15px;
                    }
                    #sendMoneyWrapper paper-button{
                        float:right;
                    }
                    #sendMoneyWrapper .buttons{
                        --paper-button-ink-color: var(--paper-green-500);
                        color: var(--paper-green-500);
                    }
                    .address-item {
                        --paper-item-focused: {
                            background: transparent;
                        }
                        ;
                        --paper-item-focused-before: {
                            opacity: 0;
                        }
                        ;
                    }

                    .address-balance {
                        font-size: 42px;
                        font-weight: 100;
                    }

                    .show-transactions {
                        cursor: pointer;
                    }

                    .address-icon {
                        border-radius: 50%;
                        border: 5px solid;
                        /*border-left: 4px solid;*/
                        padding: 8px;
                    }

                    #sendMoneyFab {
                        position: fixed;
                        right: 32px;
                        bottom: 32px;
                    }

                    paper-input {
                        margin: 0;
                    }

                    .selectedBalance {
                        font-size: 14px;
                        display: block;
                    }

                    .selectedBalance .balance {
                        font-size: 24px;
                        font-weight: 100;
                    }
                </style>
            </custom-style>
            
            <div id="sendMoneyWrapper">
                <h3>Send money</h3>
                
                <!-- CHANGE SELECTED ADDRESS TO INDEX RATHER THAN OBJECT -->
                <paper-dropdown-menu label="From" style$="width:100%; border-left: 5px solid {{selectedAddress.color}}">
                    <paper-listbox slot="dropdown-content" class="dropdown-content" attr-for-selected="address" selected="{{selectedAddress}}">
                        
                        <template is="dom-repeat" items="{{addresses}}">
                            <paper-item style$="border-left: 5px solid {{item.color}}" address="{{item}}">
                                {{item.address}}
                                <paper-ripple></paper-ripple>
                            </paper-item>
                        </template>
                        
                    </paper-listbox>
                </paper-dropdown-menu>

                <div class="selectedBalance">
                    <span class="balance">{{selectedAddress.balance}} </span>Qora available for transfer from <span style$="color: {{selectedAddress.color}}">{{selectedAddress.address}}</span>
                </div>

                <paper-input id="amountInput" required label="Amount" type="number" invalid={{validAmount}} value="{{amount}}" error-message="Insufficient funds" on-keyup="_checkAmount"></paper-input>

                <paper-input label="To" type="text" value="{{recipient}}"></paper-input>

                <paper-input label="Fee" type="text" value="{{fee}}"></paper-input>

                <p>{{sendMoneyError}}</p>

                <div class="buttons">
                    <div>
                        <paper-button autofocus on-tap="_sendMoney">Send &nbsp;<iron-icon icon="send"></iron-icon></paper-button>
                    </div>
                </div>

                <template is="dom-if" if="{{sendMoneyLoading}}">
                    <paper-progress auto></paper-progress>
                </template>
            </div>
            
        </template>
        
        
        <script src="/client/js/wimp/wimp.js"></script>
        <script>
            
            class WalletApp extends Polymer.Element {
                static get is() {
                    return "wallet-app";
                }
                static get properties(){
                    return {
                        addresses: {
                            type: Array,
                            value: []
                        },
                        fee: {
                            type: Number,
                            value: 1
                        },
                        amount: {
                            type: Number
                        },
                        sendMoneyError: {
                            type: String,
                            value: ""
                        },
                        sendMoneyLoading: {
                            type: Boolean,
                            value: false
                        },
                        data: {
                            type: Object,
                            value: {}
                        }
                    }
                }
                
                constructor() {
                    super();
                }
                
                _floor(num) {
                    return Math.floor(num);
                }
                
                _checkAmount() {
                    if (this.amount > this.selectedAddress.balance - this.fee || this.amount <= 0) {
                        this.validAmount = true;
                    }
                    else {
                        this.validAmount = false;
                    }
                }

                _sendMoney(e) {
                    var address = this.selectedAddress;
                    var amount = this.amount;
                    var recipient = this.recipient;
                    var fee = this.fee;

                    // Check for valid...^

                    this.sendMoneyLoading = true;
                    this.parentWimp.request("sendMoney", {
                        data: {
                            // Why is it index not nonce?
                            nonce: address.nonce,
                            //address: address.address,
                            amount: amount,
                            recipient: recipient,
                            fee: fee
                        }
                    }, response => {
                        console.log(response);
                        this.sendMoneyLoading = false;
                        if (!response.success) {
                            this.sendMoneyError = response.errorText;
                        }
                        else {
                            //this.$.sendMoneyDialog.close();
                        }
                    });

                    //this.$.sendMoneyDialog.close();
                }
                
                resize(){
                    this.parentWimp.request("modalFrameSize", {
                        data: {
                            height: (document.body.scrollHeight + 6) + "px", // Plus height of floated buttons
                            width: document.body.scrollWidth + "px"
                        },
                        expectResponse: false
                    })
                }
                
                ready(){
                    super.ready();
                    
                    this.coreWimp = new Wimp("core", window.parent);

                    this.coreWimp.ready(() => {
                        this.coreWimp.listen("balances", balances => {
                            this.addresses = balances;
                            
                            if(!this.selectedAddress){
                                this.resize();
                            }
                            
                            this.selectedAddress = this.selectedAddress || this.addresses[this.data.index ? this.data.index : 0]
                            
                        });
                    });
                    
                    this.parentWimp = new Wimp(window.parent);

                    this.parentWimp.ready(() => {
                        this.resize();
                    })
                    
                    this.parentWimp.on("opened", (req) => {
                        req = req || {};
                        console.log("Open with data ", req)
                        this.data = req || this.data;
                        this.selectedAddress = req.index ? this.addresses[req.index] : this.selectedAddress;
                        this.amount = req.amount || this.amount;
                        this.recipient = req.recipient || this.recipient;
                        this.resize();
                    })

                    Wimp.init();
                }
            }

            window.customElements.define(WalletApp.is, WalletApp);
        </script>
    </dom-module>

    <wallet-app></wallet-app>

<!--
    <script src="/client/js/wimp.js"></script>
    <script>
        
        const parentWimp = new Wimp(window.parent);
        
        parentWimp.ready(() => {
            parentWimp.request("hello").then(response => {
                console.log(response.data)
            })
            
            parentWimp.request("modalFrameSize", {
                data: {
                    height: document.body.scrollHeight + "px",
                    width: document.body.scrollWidth + "px"
                },
                expectResponse: false
            })
            parentWimp.on("opened", () => {
                console.log("OOPPPEEEENNNEEEDDD")
            })
        })
        
        Wimp.init();
    </script>
-->
</body>

</html>